version: 2.1

jobs:
  deploy:
    docker:
      - image: ubuntu:22.04
    steps:
      - checkout

      - run:
          name: Install SSH Client
          command: |
            apt-get update && apt-get install -y openssh-client 
            apt-get install curl gnupg -y

      - run:
          name: Install Node.js-version 18.20.4 & yarn
          command: |
            curl https://raw.githubusercontent.com/creationix/nvm/master/install.sh | bash
            source ~/.profile
            nvm install 18
            sudo apt-get install npm
            sudo npm install -g yarn
      
      - run:
          name: Create SSH Directory
          command: mkdir -p ~/.ssh
      
      - add_ssh_keys:
          fingerprints:
            - "SHA256:uDoegTrVGuEQAV3JdOekUkvJX0Y8QXuBCvys3ScnLGY"
      
      - run:
          name: Add SSH Host
          command: |
            ssh-keyscan -H 65.1.147.86 >> ~/.ssh/known_hosts
      
      - run:
          name: Update the erpnext_app
          command: |
            ssh -o StrictHostKeyChecking=no ubuntu@65.1.147.86 \<< EOF
            cd /home/ubuntu/ivend-bench/apps/erpnext
            git pull upstream develop
            bench setup requirements
            bench --site circleciproject.com migrate
            bench build
            bench restart
            EOF

workflows:
  version: 2
  deploy_workflow:
    jobs:
      - deploy
